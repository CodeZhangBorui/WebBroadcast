<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web broadcast</title>
    <script src="queue.js"></script>
    <script src="broadcast.js"></script>
</head>

<body>
    <div class="flex">
        <div class="broadcast-wrapper"></div>
        <div class="msg-wrapper">
            <ul id="msg"></ul>
        </div>
    </div>
    <div class="chat-wrapper">
        <!--<input placeholder="Chat here" name="chat" id="chat">
        <button onclick="sendMsg()">Send</button>-->
        <fluent-text-field appearance="outline" placeholder="Chat here" id="chat"></fluent-text-field>
        <fluent-button appearance="accent" onclick="sendMsg()">Send</fluent-button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        var params = {}
        window.location.search.slice(1).split('&').forEach(v => {
            var _ = v.split('=');
            params[_[0]] = _[1];
        })
        if (!params.type || !params.bid || !params.name) window.location.pathname = '/';

        socket.on("auth", () => {
            socket.emit("auth", {
                type: params.type,
                bid: params.bid,
                name: params.name
            });
        })

        socket.on("err_auth", () => {
            alert("Auth failed, Please rejoin!");
            window.location.pathname = '/'
        });
        socket.on("room_using", () => {
            alert("Room is in using, Please change broadcast id!");
            window.location.pathname = '/create'
        })
        socket.on("room_not_found", () => {
            alert("Room not found, Please check broadcast id!");
            window.location.pathname = '/join'
        })
        socket.on("authed", () => {
            alert("Successfully login, enjoy :)");
        })
        socket.on('user_join', (name) => {
            var dom = document.createElement("li");
            dom.innerText = name + ' join the room.';
            document.querySelector('#msg').appendChild(dom);
        })
        socket.on("user_leave", (data) => {
            var dom = document.createElement("li");
            dom.innerText = data.name + ' left the room. Reason: ' + data.reason;
            document.querySelector('#msg').appendChild(dom);
        })
        socket.on('message', (data) => {
            var dom = document.createElement("li");
            dom.innerText = data.name + ' : ' + data.msg;
            document.querySelector('#msg').appendChild(dom);
        })

        window.addEventListener("keypress", ({
            code
        }) => {
            if (code == 'Enter') sendMsg();
        })

        function sendMsg() {
            var msg = document.querySelector('#chat');
            var v = msg.value;
            socket.emit('chat', v);
            var dom = document.createElement("li");
            dom.innerText = params.name + ' : ' + v;
            document.querySelector('#msg').appendChild(dom);
            msg.value = '';
        }
    </script>
    <link rel="stylesheet" href="broadcast.css">
    <script type="module">
        import { allComponents, provideFluentDesignSystem } from 'https://unpkg.com/@fluentui/web-components';
        provideFluentDesignSystem().register(allComponents);
    </script>
</body>

</html>