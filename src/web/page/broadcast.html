<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web broadcast</title>
    <!-- <script src="broadcast.js"></script> -->
</head>

<body>
    <div class="flex">
        <video id="broadcast" class="broadcast-wrapper" autoplay auto-height></video>
        <img id="show">
        <div class="msg-wrapper">
            <ul id="msg"></ul>
        </div>
    </div>
    <div class="chat-wrapper">
        <!--<input placeholder="Chat here" name="chat" id="chat">
        <button onclick="sendMsg()">Send</button>-->
        <fluent-text-field appearance="outline" placeholder="Chat here" id="chat"></fluent-text-field>
        <fluent-button appearance="accent" onclick="sendMsg()">Send</fluent-button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        var params = {}
        window.location.search.slice(1).split('&').forEach(v => {
            var _ = v.split('=');
            params[_[0]] = _[1];
        })
        if (!params.type || !params.bid || !params.name) window.location.pathname = '/';

        if (params.type == 'create') {
            document.querySelector('#show').style = 'display: none;';
        } else {
            document.querySelector('#broadcast').style = 'display: none;';
        }

        function getImg() {
            var player = document.getElementById('broadcast');
            var canvas = document.createElement('canvas');
            canvas.width = document.querySelector('#broadcast').videoWidth;
            canvas.height = document.querySelector('#broadcast').videoHeight;
            var ctx = canvas.getContext("2d");

            ctx.drawImage(player, 0, 0)

            return canvas.toDataURL(undefined, 0.5);
        }

        function start() {
            navigator.mediaDevices.getDisplayMedia({
                video: true
            }).then(stream => {
                var player = document.getElementById('broadcast')
                if ("srcObject" in player) {
                    player.srcObject = stream;
                } else {
                    player.src = window.URL.createObjectURL(stream);
                }
                player.onloadedmetadata = function(e) {
                    player.play();
                }
            }).catch(err => {
                socket.emit('chat', `There's an error ocurrated in host. Error content:${err}. Can't broadcast!`)
            })
            setInterval(() => {
                var img = getImg();
                var chunks = [];

                var i = 0;
                var chunkSize = 4096;

                while (i <= img.length - chunkSize) {
                    chunks.push(img.slice(i, i + chunkSize));
                    i += chunkSize;
                }

                for (let chunkId = 0; chunkId < chunks.length; chunkId++) {
                    const chunk = chunks[chunkId];
                    socket.emit('data', {
                        chunk,
                        chunkId,
                        timestamp: (new Date()).valueOf()
                    })
                }
            }, 500);
        }

        socket.on("auth", () => {
            socket.emit("auth", {
                type: params.type,
                bid: params.bid,
                name: params.name
            });
        })

        socket.on("err_auth", () => {
            alert("Auth failed, Please rejoin!");
            window.location.pathname = '/'
        });
        socket.on("room_using", () => {
            alert("Room is in using, Please change broadcast id!");
            window.location.pathname = '/create'
        })
        socket.on("room_not_found", () => {
            alert("Room not found, Please check broadcast id!");
            window.location.pathname = '/join'
        })
        socket.on("authed", () => {
            alert("Successfully login, enjoy :)");
            if (params.type == 'create') {
                start();
            }
        })
        socket.on('user_join', (name) => {
            var dom = document.createElement("li");
            dom.innerText = name + ' join the room.';
            document.querySelector('#msg').appendChild(dom);
        })
        socket.on("user_leave", (data) => {
            var dom = document.createElement("li");
            dom.innerText = data.name + ' left the room. Reason: ' + data.reason;
            document.querySelector('#msg').appendChild(dom);
        })
        socket.on('message', (data) => {
            var dom = document.createElement("li");
            dom.innerText = data.name + ' : ' + data.msg;
            document.querySelector('#msg').appendChild(dom);
        })

        if (params.type == 'join') {
            var media = document.querySelector('#show');
            var lastTimestamp = 0;
            socket.on('data', ({
                chunk,
                chunkId,
                timestamp
            }) => {
                if (chunkId == 0 || lastTimestamp < timestamp) {
                    media.src = chunk;
                } else {
                    media.src += chunk;
                }
                lastTimestamp = timestamp;
            })
        }

        window.addEventListener("keypress", ({
            code
        }) => {
            if (code == 'Enter') sendMsg();
        })

        function sendMsg() {
            var msg = document.querySelector('#chat');
            var v = msg.value;
            socket.emit('chat', v);
            var dom = document.createElement("li");
            dom.innerText = params.name + ' : ' + v;
            document.querySelector('#msg').appendChild(dom);
            msg.value = '';
        }
    </script>
    <link rel="stylesheet" href="broadcast.css">
    <script type="module">
        import { allComponents, provideFluentDesignSystem } from 'https://unpkg.com/@fluentui/web-components'; provideFluentDesignSystem().register(allComponents);
    </script>
</body>

</html>